From 4eb23fdf2d285d710dc1f70b5158dbc6ffef48aa Mon Sep 17 00:00:00 2001
From: Timo Sirainen <timo.sirainen@open-xchange.com>
Date: Mon, 9 Sep 2024 18:46:56 +0300
Subject: [PATCH] virtual: Fix copying storage error on mail_precache() failure

Index: src/plugins/virtual/virtual-mail.c
--- src/plugins/virtual/virtual-mail.c.orig
+++ src/plugins/virtual/virtual-mail.c
@@ -240,7 +240,11 @@ static int virtual_mail_precache(struct mail *mail)
 	if (backend_mail_get(vmail, &backend_mail) < 0)
 		return -1;
 	p = (struct mail_private *)backend_mail;
-	return p->v.precache(backend_mail);
+	if (p->v.precache(backend_mail) < 0) {
+		virtual_box_copy_error(mail->box, backend_mail->box);
+		return -1;
+	}
+	return 0;
 }
 
 static void
